---
title: 小程序CI实现预览和上传
date: 2025-12-25 21:25:02
permalink: /chat/web/mini-ci    
categories:
  - 前端物语
tags:
  - javascript、闭包
---

# 小程序CI实现预览和上传

## 前言
小程序实现CI需要借助第三方包miniprgram-ci来实现，需要在相应的项目文件里面下载miniprgram-ci使用，并且在微信公众号上下载私有的key和配置上传的域名白名单可以实现代码机器人上传。
## 1、首先下载miniprgram-ci包
```
npm install miniprgram-ci --save
```

## 2、登陆微信公众号获取秘钥和配置域名白名单

![](https://files.mdnice.com/user/8233/7ef1d1a7-5cd3-4ac7-9eac-b7243ed9e9a7.png)
点击生成秘钥

![](https://files.mdnice.com/user/8233/40a202b0-aec9-4604-ae81-07902aab1f82.png)
将秘钥下载到本地项目里面

## 3、打开项目 新建一个文件start.js文件，代码如下

> 首先引入 miniprogram-ci，做好配置。
```
const CI = require('miniprogram-ci')

const project = new CI.Project({
    appid: config.appid,
    type: 'miniProgram',
    projectPath: './',
    privateKeyPath: './private.wx.key',
    ignores: ['node_modules/**/*'],
})
```
对应的属性说明

![](https://files.mdnice.com/user/8233/cfd0fb8f-c625-41f0-8ddb-e2d14700427d.png)
> 上传实现，此处的project参数就是上面配置的 CI.Project对象。
```
const update = async(version = '0.0.0', desc = '测试') => {
  await ci.upload({
        project,
        version,
        desc,
        setting: {
            es6: false,
        }
    })
}
```
对应的参数说明如下图
![](https://files.mdnice.com/user/8233/c88b928d-e6fb-4ac1-96e7-42ebb9b9c146.png)

> 预览实现,注意此处的qrcodeOutputDest属性，一定要对应本地有这样一个文件目录，可以不存在文件，目录必须有。
```
const preview = async (qrcodeFormat = 'image', desc = '') => {
    await CI.preview({
        project,
        desc, // 此备注将显示在“小程序助手”开发版列表中
        setting: {
          es6: true,
        },
        qrcodeFormat,
        qrcodeOutputDest: './path/qrcode/destination.jpg',
        onProgressUpdate: console.log,
        pagePath: 'pages/life/life', // 预览页面
        // searchQuery: 'a=1&b=2',  // 预览参数 [注意!]这里的`&`字符在命令行中应写成转义字符`\&`
      })

}
```
对应的参数说明如下图

![](https://files.mdnice.com/user/8233/f17a59e4-2854-46c5-8287-b28831de1939.png)

完整代码
```
const CI = require('miniprogram-ci')

const config = require('./project.config.json')


const project = new CI.Project({
    appid: config.appid,
    type: 'miniProgram',
    projectPath: './',
    privateKeyPath: './private.wx.key',
    ignores: ['node_modules/**/*'],
})

const update = async(version = '0.0.0', desc = '测试') => {
  await ci.upload({
        project,
        version,
        desc,
        setting: {
            es6: false,
        }
    })
}

const preview = async (qrcodeFormat = 'image', desc = '') => {
    await CI.preview({
        project,
        desc, // 此备注将显示在“小程序助手”开发版列表中
        setting: {
          es6: true,
        },
        qrcodeFormat,
        qrcodeOutputDest: './path/qrcode/destination.jpg',
        onProgressUpdate: console.log,
        pagePath: 'pages/life/life', // 预览页面
        // searchQuery: 'a=1&b=2',  // 预览参数 [注意!]这里的`&`字符在命令行中应写成转义字符`\&`
      })

}

const init = async () => {
    // await update({version: '0.0.0', desc: '测试'})
    await preview();
}

init()

```
想要实现对应的效果，只需要在init里面调用对应的函数，通过node运行js文件即可。
```
node start.js
```
预览成功的截图

![](https://files.mdnice.com/user/8233/35729933-3353-4cd7-8e83-3006d3e8b7c8.png)

会生成一个本地的预览图片。

![](https://files.mdnice.com/user/8233/0457ea7e-0148-4274-a548-65940acecca5.png)

上传成功的截图

![](https://files.mdnice.com/user/8233/f72fc1d3-36f9-4662-be08-6b89f15a8c6f.png)
上传成功后，可以在公众号平台，版本管理可以看到如下提交
![](https://files.mdnice.com/user/8233/46f15e91-ea60-40c3-adfa-1ddbeaca20de.png)


参考地址:
https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html